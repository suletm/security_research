= SYNOPSIS =

This challenge was part of the TSA National Conference CTF. I did not get a permission to disclose the full working source code of the challenge. Fortunately, the part of it that matters the most is a publicly available utility and that can be shared.

= SETUP =

A simple web application with an upload form was provided. The form could be used to upload a tar file of your choice. Once uploaded, the tar file gets extracted onto the server's filesystem. Then the server runs the tree utility on the extracted content. The arguments to the tree commands are: 

```
tree -o report.html -H . -R -L 3  your_archive
```


The version of the tree utility is 1.8.0. You are not able to overwrite any files on the filesystem using the absolute path trick inside of your tar archive. 

= Solution =

TL;DR; tree utility uses system() in an insecure way. This can be leveraged to execute an arbitrary shell command. Continue reading for the details.

Version 1.8.0 of the tree utility supports the following relevant arguments, according to its man page:

```
       -H baseHREF
              Turn on HTML output, including HTTP references. Useful for ftp sites.  baseHREF gives the base ftp location when using
              HTML output. That is, the local directory may be `/local/ftp/pub', but it must be referenced as  `ftp://hostname.orga‐
              nization.domain/pub'  (baseHREF  should be `ftp://hostname.organization.domain'). Hint: don't use ANSI lines with this
              option, and don't give more than one directory in the directory list. If you wish to use colors via  CSS  style-sheet,
              use the -C option in addition to this option to force color output.
```

```
       -R     Recursively  cross down the tree each level directories (see -L option), and at each of them execute tree again adding
              `-o 00Tree.html' as a new option.
```

```
       -L level
              Max display depth of the directory tree.
```

```
       -o filename
              Send output to filename.
```              

Note the -R flag, which instructs tree to recursively decent into the directory hierarchy, but most importantly, it re-executes the tree utility again ! The source code (available from Indiana State University here: ftp://mama.indstate.edu/linux/tree/tree-1.8.0.tgz) for handling the relevant part of the -R argument looks like this:

```
# Filename html.c

149     if (Rflag && (lev == Level) && (*dir)->isdir) {
...
169       sprintf(hcmd,"tree -n -H \"%s%s/%s\" -L %d -R -o \"%s/00Tree.html\" \"%s\"\n", host,d+1,(*dir)->name,Level+1,path,path);
170       printf("About to execute...: %s\n", hcmd);
171       system(hcmd);
...
174     } else {
...
```

At line 149 the code checks if the recursive flag "Rflag" is enabled (-R ), then checks the target (from the -L argument) and current level equality and finally checks if the target is a directory. If these checks are satisfied, then at line 169 a command string is built and executed with system() at line 171. This corresponds to the information in the man page about the -R flag. Look at the line 169, where the command string is built. Do you notice anything suspicious ? First, we sort of have this gut feeling, that building dynamic command strings for system() is usually fraught with errors. And indeed, we can influence the resulting string by manipulating the directory name: (*dir)->name. 

Using this information we can craft the following directory hierarchy:

```
root_dir
    - dir_a
        - dir_b
            - a";ARBITRARY_SHELL_COMMAND;"
```

The hierarchy needs to be 3 levels deep to pass the level equality check mentioned above. Once the tree utility reaches the special directory it'll execute the ARBITRARY_SHELL_COMMAND.

= Retrospective =

Running tree on directories from unknown origin can be used to compromise your system. Fortunately, this bug is triggered only when html reporting is enabled with a recursive flag.

The issue was fixed in tree version 2.0.0. However, Ubuntu 20.x LTS still seems to have the vulnerable version:

```
ubuntu@washington:~$ lsb_release  -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 20.04.4 LTS
Release:	20.04
Codename:	focal
ubuntu@washington:~$ objdump  -D  /usr/bin/tree  |grep system
0000000000004170 <system@plt>:
    4170:	ff 25 42 0d 01 00    	jmpq   *0x10d42(%rip)        # 14eb8 <system@GLIBC_2.2.5>
    9da4:	e8 c7 a3 ff ff       	callq  4170 <system@plt>
    aaf2:	e8 79 96 ff ff       	callq  4170 <system@plt>
ubuntu@washington:~$
```
